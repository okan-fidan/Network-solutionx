<analysis>

**original_problem_statement**: The user initiated the session with a request to fix all outstanding and unfinished issues. Over the course of the session, they introduced several major new feature requests:
1.  **Push Notifications**: Implement notifications for new messages (DMs, group chats) and post likes.
2.  **Instagram-Style Stories**: A complete story system where only users can post photo/video stories that auto-delete after 24 hours. The system must support replies, emoji reactions, reporting, blocking, and deletion.
3.  **Membership/Subscription**: A two-tier membership system (Free with ads, a 70₺ one-time payment for Premium without ads) using PayTR for payments.
4.  **AdMob Integration**: Implement real AdMob banner ads using provided Ad Unit and App IDs.
5.  **Sub-Admin/Moderator Role**: Create a Sub-admin role with specific permissions: delete group messages, ban users for 30 minutes, and remove non-admin members with a reason form.

The user also reported and requested fixes for several bugs during the session, including a crash related to notifications, a broken add story button, the messages tab being stuck on loading, profile picture upload failures (520 error), and a white screen in the add service category picker.

**User's preferred language**: Türkçe (Turkish). The next agent MUST respond in Turkish.

**what currently exists?**
The application is a full-featured social platform. Key systems include:
-   **Authentication**: Complete login, signup, and profile management flow.
-   **Messaging**: Functional Direct Messaging and Group Chat.
-   **Stories**: A comprehensive, Instagram-style story system has been implemented on the main tab (). It supports photo/video upload, viewing, replying, emoji reactions, reporting, and user blocking. Stories are correctly fetched from a dedicated backend API and auto-delete after 24 hours.
-   **Push Notifications**: The backend is configured to send push notifications for new group messages, DMs, and post likes. A critical client-side crash related to  in Expo Go has been resolved by refactoring to use lazy-loading for the module.
-   **Membership System**: A full membership system is in place. A new  page allows users to upgrade to a Premium tier via a one-time payment, handled by a PayTR integration on the backend (in test mode). The  component is now aware of the user's membership status and hides ads for premium users.
-   **Monetization**: Real AdMob banner ads are integrated and configured with the user's production Ad Unit ID and App ID.
-   **Backend**: The  file has been massively expanded with new endpoints for stories, membership, PayTR callbacks, and the initial structure for the moderator role. Numerous bugs related to data consistency (e.g.,  vs ) have been fixed and verified via backend testing.

**Last working item**:
-   **Last item agent was working**: Implementing the Sub-admin (Moderator) feature as requested by the user.
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: Both.
    -   **Backend**: Use  to verify the new moderator endpoints (promote/demote, ban, kick with reason).
    -   **Frontend**: Use  to log in as an admin, navigate to a group chat, promote a user to moderator, log in as the moderator, and verify they can see and use the new moderation tools (delete message, ban, kick non-admins).
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1: (P1) Admin Panel Core Functionality is Broken/Unverified.**
    -   **Description**: This was the original P0 issue from the start of the project. The user's initial reports about the admin panel (Üyeleri Yönet, Topluluk Ayarları, İstekler) are still not confirmed as fixed. This has been repeatedly postponed due to other feature requests.
    -   **Attempted fixes**: Some backend endpoints were added and some UI was modified in previous sessions, but no end-to-end testing has been performed.
    -   **Next debug checklist**:
        1.  Log in as the admin user ().
        2.  Systematically test every button and feature in the admin sections: Topluluk Yönetimi, Üye Yönetimi, and İstekler.
        3.  Verify that join requests can be approved/rejected, members can be managed, and community settings can be changed.
        4.  Inspect frontend console and backend logs for errors during these actions.
    -   **Why fix this issue and what will be achieved with the fix?**: This is a critical blocking issue for app administration and has been the user's longest-standing unresolved request.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on other issue**: Blocked by the currently in-progress Moderator System task.

-   **Issue 2: (P2) Push Notification Frontend Registration is Incomplete.**
    -   **Description**: While the backend sends notifications and a client-side crash was fixed, the complete frontend flow for handling notifications (requesting permission from the user upon app start/login, getting the Expo Push Token, and saving it to the backend via ) is not explicitly implemented or verified.
    -   **Next debug checklist**:
        1.  Review  or the root layout file ().
        2.  On app startup or after login, implement a call to a function (e.g., in ) that requests permission.
        3.  If permission is granted, retrieve the token and call the API to save it.
        4.  Ensure this flow doesn't re-trigger the not supported in Expo Go error.
    -   **Why fix this issue and what will be achieved with the fix?**: Without this, push notifications will not work for any user as the app never gets their permission or token.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on other issue**: None.

-   **Issue 3: (P3) Profile Creation Fails on Web Preview.**
    -   **Description**: A bug was observed in a previous session where a user loses their auth state after signing up and being redirected to the  page on the web preview, causing the profile save to fail.
    -   **Attempted fixes**: None. This has been consistently de-prioritized.
    -   **Next debug checklist**:
        1.  Examine  and the navigation flow between  and .
        2.  Ensure the Firebase auth state is persisted and available in the context before the profile creation API call is made.
    -   **Why fix this issue and what will be achieved with the fix?**: Prevents new user registration on the web preview, hindering testing.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on other issue**: None.

**In progress Task List**:
-   **Task 1: (P0) Finalize Moderator (Sub-Admin) System**
    -   **Where to resume**: The agent has already created backend endpoints, frontend API functions, and the file . The next steps are:
        1.  In , add a Moderatör Paneli (Moderator Panel) button in the group settings/header, visible only to admins, that navigates to the new panel.
        2.  Fully implement the UI/logic in  to list group members and allow admins to promote users to moderators.
        3.  In , update the long-press menu on members/messages to show moderation options (Ban, Kick, Delete Message) to moderators. The Kick action should open a modal to enter a reason.
    -   **What will be achieved with this?**: Fulfills the user's latest complex feature request for role-based permissions.
    -   **Status**: IN PROGRESS
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on something**: No.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   **(P1) Admin Panel Overhaul**: Once the moderator task is done, a full, dedicated effort is needed to test and fix all parts of the admin panel.
    -   **(P2) Implement Polls and Location Sharing**: The work on polls and map-based location sharing in group chat () was started but abandoned. This can be resumed later.
-   **Future Tasks**:
    -   Implement the stubbed Group Media Page ().
    -   Implement Voice Messages and Search in chat.
    -   Implement the stubbed Appointment & Project systems.

**Completed work in this session**
-   **REFACTORED**: Backend data models to consistently use  instead of .
-   **IMPLEMENTED**: Push notifications for new group messages and post likes.
-   **IMPLEMENTED**: A complete, Instagram-style Stories feature (create, view with progress bar, reply, react, report, block, delete, 24-hour auto-deletion).
-   **IMPLEMENTED**: A full Membership system with Free (ads) and Premium (no-ads) tiers, using a one-time payment via a PayTR test integration.
-   **IMPLEMENTED**: Real AdMob banner ads using the user's production Ad Unit ID and App ID.
-   **FIXED**: Critical Expo Go crash caused by .
-   **FIXED**: Bug where the Add Story button incorrectly created a post.
-   **FIXED**: The  tab getting stuck in a loading state.
-   **FIXED**: Profile picture upload failure (520 error) by implementing robust client-side image compression.
-   **FIXED**: A white screen bug in the Add Service category picker by replacing the native picker with a custom, more reliable modal component.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Admin Panel Functionality**. The original P0 task to fix the admin panel was never completed and remains the most significant piece of technical debt.
-   **Issue 2: Polls & Location Sharing UI**. This was the last working item from the previous handoff but was superseded by new user requests. The modals and state exist in  but are not fully wired up.

**Code Architecture**


**Key Technical Concepts**
-   **Third-Party Payment Integration**: Implemented a full payment flow with PayTR, including generating payment tokens and handling server-side callbacks.
-   **Mobile Ad Monetization**: Integrated  with production keys and linked ad visibility to a premium membership status.
-   **Complex UI/State Management**: Built an Instagram-clone story viewer within a single React component () managing complex state for timers, gestures, user interactions, and multiple modals.
-   **Robust Component Replacement**: Proactively replaced a buggy default component () with a custom-built, superior UX pattern (Modal with a list) to solve a critical UI issue.
-   **Proxy/Gateway Error Handling**: Diagnosed and worked around a Cloudflare 520 error by implementing aggressive client-side image compression, demonstrating an understanding of real-world deployment constraints.
-   **Safe Module Loading**: Fixed a critical Expo Go crash by refactoring a module () to be lazy-loaded, preventing top-level calls that are unsupported in the development client.

**All files of reference**
-   : The core of all new business logic.
-   : The heart of the new Stories feature.
-   : The new file for the current task.
-   : The entry point for the moderator panel.
-   : This entire directory needs to be reviewed and fixed.

**Critical Info for New Agent**
-   **Dili Türkçe Kullan**: You must communicate with the user in Turkish.
-   **Immediate Task (P0)**: Your first priority is to complete the **Moderator System**. The backend/API groundwork is laid; you need to build the frontend UI in  and integrate the entry points and action menus into .
-   **Next Top Priority (P1)**: After the moderator feature, you MUST finally address the long-pending **Admin Panel** issues. This has been requested since the beginning and cannot be postponed again. Perform a full, systematic test and fix all broken functionality.
-   **Review Pending Issues**: Be aware of the other pending items: completing the push notification registration flow and the web signup bug.

**Last 10 User Messages and any pending HUMAN messages**
-   **Msg 359/356 (COMPLETED)**: User confirmed choice for PayTR + In-App, one-time payment for the new membership feature.
-   **Msg 339 (COMPLETED)**: Reported a white screen on the add service category page.
-   **Msg 312 (COMPLETED)**: Reported a 520 error when uploading a profile picture.
-   **Msg 279 (COMPLETED)**: Reported that the messages tab was stuck on loading indefinitely.
-   **Msg 252 (COMPLETED)**: Requested story deletion, replying, and reporting features to be added to the story viewer.
-   **Msg 241 (COMPLETED)**: Reported that the add story button was creating a post instead of a story.
-   **Msg 208 (COMPLETED)**: Reported a crash related to  in Expo Go.
-   **Msg 163 (COMPLETED)**: Requested the story system be expanded to be like Instagram (video, replies, reactions, reporting).
-   **Msg 74 (COMPLETED)**: Requested push notifications for messages/likes and a revamp of the story system.
-   **Msg 5 (IN PROGRESS)**: The overarching request to solve all unfinished and pending issues.

**Project Health Check:**
-   **Broken**:
    -   Admin Panel: The entire admin section is unverified and assumed to be non-functional.
-   **Incomplete/Stubbed**:
    -   **Moderator System**: Backend/API is partially done, but the frontend UI is a stub () and not yet integrated.
    -   **Push Notifications**: The frontend logic for registering a user's device token is still missing.

**3rd Party Integrations**
-   Firebase (Authentication)
-   PayTR (Payments - Test Mode)
-   AdMob ()
-   , , , , 
-   
-   

**Testing status**
-   **Testing agent used after significant changes**: YES,  was used multiple times and confirmed backend APIs were working after major changes and bug fixes.
-   **Test files created**: None.
-   **Known regressions**: None identified, but the Admin Panel is a long-standing known broken area.

**Credentials to test flow:**
-   **Admin User**:  (a new user can be created with this email to gain admin rights).
-   **PayTR Test Credentials**: Hardcoded in .

**What agent forgot to execute**
-   The agent has consistently postponed fixing the **Admin Panel**, which was the original P0 task of the entire project. This remains the most significant piece of unfinished work.
-   The agent did not complete the full push notification flow (token registration).
-   The agent started but did not complete the Polls and Location Sharing features from the previous handoff.

</analysis>
